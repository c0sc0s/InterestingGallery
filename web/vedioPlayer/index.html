<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="mobile-web-app-capable" content="yes" />
    <title>Retro CRT Player 1982 Limited Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=VT323&family=Orbitron:wght@500&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --phosphor-main: #2dd760;
        --phosphor-bloom: #7aff9e;
        --crt-bg: #111;
        /* æœ¨çº¹æè´¨é¢œè‰² */
        --wood-dark: #3e2723;
        --wood-light: #5d4037;
        --metal-panel: #2a2a2a;
        --btn-highlight: #444;
        --btn-shadow: #111;
      }

      body {
        background-color: #050505;
        color: var(--phosphor-main);
        font-family: "VT323", monospace;
        overflow: hidden;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-image: radial-gradient(
          circle at 50% 50%,
          #1a1a1a 0%,
          #000 100%
        );
        perspective: 1000px;
      }

      /* --- ç”µè§†å¤–å£³ (æœ¨çº¹ + å¡‘æ–™) --- */
      .tv-casing {
        /* æœ¨çº¹ç”Ÿæˆ */
        background: linear-gradient(rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.6)),
          repeating-linear-gradient(
            90deg,
            var(--wood-dark) 0px,
            var(--wood-dark) 4px,
            var(--wood-light) 5px,
            var(--wood-dark) 10px,
            var(--wood-light) 12px
          );
        padding: 25px;
        border-radius: 12px;
        box-shadow: inset 2px 2px 5px rgba(255, 255, 255, 0.1),
          /* é«˜å…‰ */ inset -5px -5px 15px rgba(0, 0, 0, 0.8),
          /* é˜´å½± */ 0 30px 60px rgba(0, 0, 0, 0.9),
          /* è½åœ°é˜´å½± */ 0 0 0 4px #1a1a1a; /* å¤–æ¡†æ¥ç¼ */
        border-bottom: 8px solid #1a0e08;
        width: 92vw;
        max-width: 860px;
        position: relative;
        transform: rotateX(2deg); /* å¾®å¾®ä»°è§† */
      }

      /* å“ç‰Œé“­ç‰Œ */
      .brand-badge {
        position: absolute;
        top: 28px;
        right: 30px;
        background: linear-gradient(135deg, #d4af37, #aa8c2c);
        color: #222;
        padding: 2px 8px;
        font-family: "Orbitron", sans-serif;
        font-size: 0.7rem;
        font-weight: bold;
        border-radius: 2px;
        box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        z-index: 50;
        letter-spacing: 1px;
        border: 1px solid #775e18;
      }

      /* å±å¹•è¾¹æ¡† (Bezel) */
      .screen-bezel {
        background: #111;
        padding: 15px 15px 30px 15px; /* åº•éƒ¨å®½ä¸€ç‚¹ */
        border-radius: 35px / 28px;
        box-shadow: inset 0 0 10px #000, 0 0 0 2px #333;
        margin-bottom: 20px;
        border-bottom: 2px solid #444; /* è£…é¥°çº¿æ¡ */
      }

      .crt-screen-container {
        position: relative;
        background: #000;
        border-radius: 60px / 40px; /* æ›´åœ†æ¶¦çš„æ˜¾åƒç®¡ */
        overflow: hidden;
        width: 100%;
        aspect-ratio: 4/3;
        box-shadow: inset 0 0 90px rgba(0, 0, 0, 0.9);
        border: 4px solid #000;
      }

      /* è§†é¢‘å±‚ - å¢åŠ æ··åˆæ¨¡å¼å¢å¼ºå‘å…‰æ„Ÿ */
      video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: relative;
        z-index: 1;
        opacity: 0;
        transition: opacity 0.5s;
      }

      /* ç°å°˜ä¸åˆ’ç—•å±‚ */
      .screen-dirt {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48ZmlsdGVyIGlkPSJnoiPjxmZVR1cmJ1bGVuY2UgdHlwZT0iZnJhY3RhbE5vaXNlIiBiYXNlRnJlcXVlbmN5PSIwLjgiIG51bT1vY3RhdmVzPSIzIiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI2cpIiBvcGFjaXR5PSIwLjEiLz48L3N2Zz4=");
        opacity: 0.15;
        pointer-events: none;
        z-index: 15;
        mix-blend-mode: overlay;
      }

      /* --- æ•…éšœæ•ˆæœç±» (Glitch FX) --- */
      /* 1. å‚ç›´æ»šåŠ¨ (V-Hold) */
      @keyframes v-hold-roll {
        0% {
          transform: translateY(0);
        }
        100% {
          transform: translateY(100%);
        }
      }
      .glitch-v-hold video {
        animation: v-hold-roll 0.2s linear infinite;
        filter: blur(2px);
      }

      /* 2. ä¿¡å·æ’•è£‚ (Tear) */
      .glitch-tear video {
        transform: skewX(-10deg) scaleX(1.1);
        filter: contrast(2);
      }

      /* 3. è‰²å½©ä¸¢å¤± (Chroma Loss) */
      .glitch-chroma video {
        filter: grayscale(1) brightness(1.5) !important;
      }

      /* æ‰«æçº¿çº¹ç† */
      .scanlines {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0),
          rgba(255, 255, 255, 0) 50%,
          rgba(0, 0, 0, 0.5) 50%,
          rgba(0, 0, 0, 0.5)
        );
        background-size: 100% 3px;
        z-index: 10;
        pointer-events: none;
        opacity: 0.5;
      }

      /* å±å¹•å…‰æ™• */
      .crt-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 11;
        background: radial-gradient(
          circle,
          rgba(20, 20, 20, 0) 60%,
          rgba(0, 0, 0, 0.7) 100%
        );
        pointer-events: none;
        animation: flicker 0.15s infinite;
      }

      /* RGB åƒç´ ç½‘æ ¼ */
      .rgb-grid {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 9;
        background-image: linear-gradient(
          90deg,
          rgba(255, 0, 0, 0.1),
          rgba(0, 255, 0, 0.05),
          rgba(0, 0, 255, 0.1)
        );
        background-size: 3px 100%;
        pointer-events: none;
      }

      @keyframes flicker {
        0% {
          opacity: 0.92;
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0.94;
        }
      }

      @keyframes turn-on {
        0% {
          transform: scale(1, 0.002) skewX(0deg);
          opacity: 1;
          filter: brightness(3);
        }
        50% {
          transform: scale(1, 0.002) skewX(0deg);
          opacity: 1;
        }
        70% {
          transform: scale(1, 1) skewX(0deg);
          opacity: 1;
        }
        100% {
          transform: scale(1, 1) skewX(0deg);
          opacity: 1;
        }
      }

      @keyframes turn-off {
        0% {
          transform: scale(1, 1.3) translate3d(0, 0, 0);
          filter: brightness(1);
          opacity: 1;
        }
        60% {
          transform: scale(1, 0.001) translate3d(0, 0, 0);
          filter: brightness(10);
        }
        100% {
          transform: scale(0, 0.001) translate3d(0, 0, 0);
          filter: brightness(50);
          opacity: 0;
        }
      }

      .crt-on video {
        animation: turn-on 2s linear forwards;
        opacity: 1;
      }
      .crt-off video {
        animation: turn-off 0.5s ease-out forwards;
      }

      /* --- é£æ ¼æ»¤é•œ (Filters) --- */
      .filter-vhs video {
        filter: contrast(1.3) brightness(1.1) saturate(1.2) sepia(0.2)
          blur(0.6px);
      }
      .filter-bw video {
        filter: grayscale(1) contrast(1.4) brightness(0.9) sepia(0.1);
      }
      .filter-cyber video {
        filter: hue-rotate(45deg) contrast(1.5) saturate(2);
      }

      /* --- UI æ–‡æœ¬ --- */
      .osd-text {
        position: absolute;
        z-index: 12;
        color: var(--phosphor-main);
        text-shadow: 0 0 5px var(--phosphor-bloom), 2px 0 0 rgba(255, 0, 0, 0.5),
          -2px 0 0 rgba(0, 0, 255, 0.5);
        font-size: 1.5rem;
        pointer-events: none;
        opacity: 0.85;
        letter-spacing: 2px;
        font-family: "VT323", monospace;
      }

      .upload-zone {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 20;
        text-align: center;
        border: 2px dashed #555;
        padding: 40px;
        background: rgba(0, 0, 0, 0.85);
        color: #888;
        cursor: pointer;
        transition: all 0.3s;
        font-family: sans-serif;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .upload-zone:hover {
        border-color: var(--phosphor-main);
        color: var(--phosphor-main);
        box-shadow: 0 0 20px rgba(45, 215, 96, 0.2);
      }

      /* --- é‡‘å±æ§åˆ¶é¢æ¿ --- */
      .controls-panel {
        margin-top: -15px; /* ç¨å¾®åµŒå…¥ Bezel */
        position: relative;
        z-index: 5;
        display: flex;
        gap: 20px;
        padding: 20px 30px;
        background: linear-gradient(to bottom, #333, #222);
        border-radius: 4px;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1),
          0 4px 8px rgba(0, 0, 0, 0.5);
        align-items: center;
        border: 1px solid #111;
      }

      /* ç‰©ç†æŒ‰é”®é£æ ¼ */
      .btn-physical {
        background: linear-gradient(to bottom, #444, #333);
        border: none;
        box-shadow: 0 4px 0 #1a1a1a, /* ä¾§é¢åšåº¦ */ 0 5px 5px rgba(0, 0, 0, 0.5); /* é˜´å½± */
        color: #bbb;
        padding: 10px 20px;
        font-family: sans-serif;
        font-weight: bold;
        font-size: 1.2rem;
        cursor: pointer;
        text-transform: none;
        border-radius: 4px;
        transition: all 0.1s;
        position: relative;
        min-width: 50px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .btn-physical:active,
      .btn-physical.active {
        transform: translateY(4px); /* æŒ‰ä¸‹æ•ˆæœ */
        box-shadow: 0 0 0 #1a1a1a, inset 0 2px 5px rgba(0, 0, 0, 0.8);
        background: #2a2a2a;
        color: var(--phosphor-main);
      }
      /* Stop æŒ‰é’®ç‰¹æ®Šè‰² */
      #btn-stop {
        color: #ff6b6b;
      }
      #btn-stop:active {
        color: #a00;
      }

      .control-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
      }
      .control-label {
        font-size: 0.6rem;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-family: sans-serif;
        text-shadow: 0 1px 0 rgba(0, 0, 0, 0.8);
      }

      /* æ¨¡å¼åˆ‡æ¢å¼€å…³ - çœ‹èµ·æ¥åƒæ»‘åŠ¨å¼€å…³ */
      .mode-switch {
        display: flex;
        background: #111;
        padding: 4px;
        border-radius: 20px;
        box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.8);
        border: 1px solid #444;
      }
      .mode-btn {
        background: transparent;
        border: none;
        color: #666;
        padding: 6px 12px;
        font-size: 1.1rem;
        font-weight: normal;
        cursor: pointer;
        border-radius: 16px;
        transition: all 0.2s;
        min-width: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .mode-btn.active {
        background: #555;
        color: #fff;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
      }

      /* å¤å¤æ»‘å— */
      input[type="range"] {
        -webkit-appearance: none;
        width: 100px;
        height: 6px;
        background: #111;
        border-radius: 3px;
        border: 1px solid #444;
        outline: none;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 12px;
        height: 20px;
        background: #888;
        border: 1px solid #ccc;
        border-radius: 2px;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      }

      input[type="file"] {
        display: none;
      }

      #noise-canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0.08;
        pointer-events: none;
        z-index: 8;
      }

      /* è£…é¥°ç”¨æ ¼æ … */
      .speaker-grill {
        width: 60px;
        height: 40px;
        background: repeating-linear-gradient(0deg, #111, #111 2px, #333 3px);
        border-radius: 2px;
        border: 1px solid #000;
      }

      /* --- ç§»åŠ¨ç«¯è§¦æ‘¸ä¼˜åŒ– --- */
      @media (max-width: 768px) {
        * {
          -webkit-tap-highlight-color: transparent;
          -webkit-touch-callout: none;
        }

        body {
          overflow-y: auto;
          padding: 10px;
          justify-content: flex-start;
          perspective: none;
          -webkit-overflow-scrolling: touch;
        }

        h1 {
          font-size: 1.2rem !important;
          margin-bottom: 10px !important;
          letter-spacing: 0.2em !important;
        }

        .tv-casing {
          width: 95vw;
          max-width: none;
          padding: 15px;
          transform: none;
          margin: 10px 0;
        }

        .brand-badge {
          top: 18px;
          right: 15px;
          font-size: 0.5rem;
          padding: 1px 6px;
        }

        .screen-bezel {
          padding: 10px 10px 20px 10px;
          border-radius: 20px / 15px;
          margin-bottom: 15px;
        }

        .crt-screen-container {
          border-radius: 30px / 20px;
          border: 2px solid #000;
        }

        .osd-text {
          font-size: 1rem;
          letter-spacing: 1px;
        }

        .osd-text.top-8 {
          top: 1rem;
          left: 1rem;
        }

        .osd-text.bottom-8 {
          bottom: 1rem;
          right: 1rem;
          font-size: 0.9rem;
        }

        .upload-zone {
          padding: 30px 20px;
          font-size: 0.9rem;
        }

        .upload-zone .text-4xl {
          font-size: 2rem;
        }

        .controls-panel {
          flex-direction: column;
          gap: 15px;
          padding: 15px 20px;
          margin-top: -10px;
        }

        .controls-panel > .flex-1 {
          width: 100%;
          justify-content: space-around;
        }

        .speaker-grill {
          display: none; /* ç§»åŠ¨ç«¯éšè—è£…é¥°æ ¼æ … */
        }

        .controls-panel > div.h-10 {
          display: none; /* éšè—åˆ†éš”çº¿ */
        }

        .btn-physical {
          padding: 12px 24px;
          font-size: 0.9rem;
          min-width: 80px;
          min-height: 44px; /* è§¦æ‘¸å‹å¥½å°ºå¯¸ */
        }

        .control-group {
          gap: 8px;
        }

        .control-label {
          font-size: 0.55rem;
        }

        .mode-switch {
          width: 100%;
          justify-content: center;
        }

        .mode-btn {
          padding: 8px 16px;
          font-size: 0.75rem;
          min-height: 36px;
          flex: 1;
        }

        input[type="range"] {
          width: 120px;
          height: 8px;
        }

        input[type="range"]::-webkit-slider-thumb {
          width: 16px;
          height: 24px;
        }

        .flex.flex-col.gap-2 {
          width: 100%;
          align-items: center;
        }

        .flex.items-center.gap-2 {
          flex-direction: column;
          gap: 8px;
        }

        #static-noise span {
          font-size: 1.5rem !important;
        }
      }

      @media (max-width: 480px) {
        body {
          padding: 5px;
        }

        h1 {
          font-size: 1rem !important;
          margin-bottom: 8px !important;
        }

        .tv-casing {
          width: 98vw;
          padding: 12px;
        }

        .brand-badge {
          top: 15px;
          right: 12px;
          font-size: 0.45rem;
          padding: 1px 4px;
        }

        .screen-bezel {
          padding: 8px 8px 15px 8px;
          border-radius: 15px / 10px;
        }

        .crt-screen-container {
          border-radius: 20px / 15px;
        }

        .osd-text {
          font-size: 0.85rem;
        }

        .osd-text.top-8 {
          top: 0.5rem;
          left: 0.5rem;
        }

        .osd-text.bottom-8 {
          bottom: 0.5rem;
          right: 0.5rem;
          font-size: 0.75rem;
        }

        .upload-zone {
          padding: 20px 15px;
          font-size: 0.8rem;
        }

        .upload-zone .text-4xl {
          font-size: 1.5rem;
        }

        .controls-panel {
          padding: 12px 15px;
          gap: 12px;
        }

        .btn-physical {
          padding: 10px 20px;
          font-size: 0.8rem;
          min-width: 70px;
        }

        .mode-btn {
          padding: 6px 12px;
          font-size: 0.7rem;
        }

        input[type="range"] {
          width: 100px;
        }
      }

      /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
      @media (max-width: 768px) and (orientation: landscape) {
        body {
          overflow-y: auto;
        }

        .tv-casing {
          width: 90vw;
          max-width: 600px;
        }

        .controls-panel {
          flex-direction: row;
          flex-wrap: wrap;
        }

        .controls-panel > .flex-1 {
          width: auto;
        }
      }
    </style>
  </head>
  <body>
    <!-- é¡¶ç›–è£…é¥° -->
    <h1
      class="text-3xl mb-4 text-white/20 tracking-[0.5em] font-bold uppercase text-center"
      style="text-shadow: 0 2px 4px black"
    >
      Retro Vision
    </h1>

    <div class="tv-casing">
      <div class="brand-badge">ROAI PRODUCT</div>

      <!-- å±å¹•è¾¹æ¡† -->
      <div class="screen-bezel">
        <div class="crt-screen-container filter-vhs" id="screen">
          <!-- è§†è§‰ç‰¹æ•ˆå±‚ -->
          <div class="scanlines"></div>
          <div class="rgb-grid"></div>
          <div class="screen-dirt"></div>
          <!-- æ–°å¢ï¼šå±å¹•ç°å°˜ -->
          <div class="crt-overlay"></div>
          <canvas id="noise-canvas"></canvas>

          <!-- OSD ä¿¡æ¯ -->
          <div
            class="osd-text top-8 left-8"
            id="osd-play"
            style="display: none"
          >
            â–¶ PLAY <br />
            <span class="text-lg opacity-70">SP</span>
          </div>
          <div class="osd-text bottom-8 right-8 text-right">
            <span id="timestamp">00:00:00</span><br />
            <span id="date-stamp" class="text-xl text-yellow-500 opacity-80"
              >OCT 21 1985</span
            >
          </div>

          <!-- æ•…éšœæŒ‡ç¤ºå™¨ (Debugç”¨ï¼Œå¹³æ—¶éšè—) -->
          <div
            id="glitch-msg"
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-red-600 font-bold border-2 border-red-600 p-2 z-50 hidden bg-black"
          >
            TRACKING ERROR
          </div>

          <!-- è§†é¢‘å…ƒç´  -->
          <video id="video-player" loop playsinline></video>

          <!-- ä¸Šä¼  UI -->
          <label class="upload-zone" id="upload-ui">
            <div class="text-4xl mb-2 text-white">ğŸ“¼</div>
            <div class="font-bold">Insert Tape</div>
            <div class="text-xs mt-2 opacity-60">MP4 / WEBM / MOV</div>
            <input type="file" id="file-input" accept="video/*" />
          </label>

          <!-- æ— ä¿¡å·é™æ€ -->
          <div
            id="static-noise"
            class="absolute inset-0 bg-neutral-900 z-0 flex items-center justify-center"
          >
            <span
              class="text-4xl text-white/20 font-mono tracking-widest animate-pulse"
              >NO SIGNAL</span
            >
          </div>
        </div>
      </div>

      <!-- ç‰©ç†æ§åˆ¶é¢æ¿ -->
      <div class="controls-panel">
        <div class="speaker-grill"></div>
        <!-- è£…é¥°å–‡å­ -->

        <div class="flex-1 flex justify-center gap-4">
          <div class="control-group">
            <button class="btn-physical" id="btn-play" title="Play">â–¶</button>
          </div>
          <div class="control-group">
            <button class="btn-physical" id="btn-pause" title="Pause">â¸</button>
          </div>
          <div class="control-group">
            <button class="btn-physical" id="btn-stop" title="Eject">â¹</button>
          </div>
        </div>

        <div class="h-10 w-px bg-black/50 border-r border-white/10 mx-2"></div>

        <div class="flex flex-col gap-2 items-center">
          <div class="mode-switch">
            <button
              class="mode-btn active"
              onclick="setFilter('filter-vhs', this)"
              title="VHS Mode"
            >
              ğŸ“¼
            </button>
            <button
              class="mode-btn"
              onclick="setFilter('filter-bw', this)"
              title="Black & White"
            >
              âš«
            </button>
            <button
              class="mode-btn"
              onclick="setFilter('filter-cyber', this)"
              title="Cyber"
            >
              âš¡
            </button>
          </div>
          <div class="flex items-center gap-2">
            <span class="control-label">ğŸ“¡</span>
            <input
              type="range"
              min="0"
              max="10"
              value="0"
              id="tracking-control"
              title="Tracking"
            />
          </div>
        </div>

        <div class="speaker-grill"></div>
        <!-- è£…é¥°å–‡å­ -->
      </div>
    </div>

    <script>
      const video = document.getElementById("video-player");
      const fileInput = document.getElementById("file-input");
      const uploadUI = document.getElementById("upload-ui");
      const screen = document.getElementById("screen");
      const staticNoise = document.getElementById("static-noise");
      const osdPlay = document.getElementById("osd-play");
      const btnPlay = document.getElementById("btn-play");
      const btnPause = document.getElementById("btn-pause");
      const trackingControl = document.getElementById("tracking-control");
      const noiseCanvas = document.getElementById("noise-canvas");

      let isPoweredOn = false;
      let glitchInterval;
      let pendingVideoFile = null; // ç”¨äºç§»åŠ¨è®¾å¤‡å»¶è¿Ÿæ’­æ”¾

      // æ£€æµ‹æ˜¯å¦ä¸º iOS è®¾å¤‡
      function isIOS() {
        return (
          /iPad|iPhone|iPod/.test(navigator.userAgent) ||
          (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1)
        );
      }

      // æ£€æµ‹æ˜¯å¦ä¸º Android è®¾å¤‡
      function isAndroid() {
        return /Android/.test(navigator.userAgent);
      }

      // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡ï¼ˆiOS æˆ– Androidï¼‰
      function isMobileDevice() {
        return isIOS() || isAndroid();
      }

      // --- éŸ³é¢‘å¤„ç†ç³»ç»Ÿ (Audio Processing) ---
      let audioContext = null;
      let sourceNode = null;
      let gainNode = null;
      let lowpassFilter = null;
      let highpassFilter = null;
      let distortionNode = null;
      let noiseGainNode = null;
      let noiseSource = null;
      let compressorNode = null;
      let hasAudio = false;
      let currentGlitchType = null;

      // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
      function initAudioContext() {
        if (!audioContext) {
          audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();

          // åˆ›å»ºéŸ³é¢‘èŠ‚ç‚¹é“¾
          gainNode = audioContext.createGain();
          lowpassFilter = audioContext.createBiquadFilter();
          highpassFilter = audioContext.createBiquadFilter();
          distortionNode = audioContext.createWaveShaper();
          compressorNode = audioContext.createDynamicsCompressor();
          noiseGainNode = audioContext.createGain();

          // é…ç½®ä½é€šæ»¤æ³¢å™¨ï¼ˆæ¨¡æ‹Ÿè€å¼æ‰¬å£°å™¨ï¼‰
          lowpassFilter.type = "lowpass";
          lowpassFilter.frequency.value = 5000; // é»˜è®¤5kHz
          lowpassFilter.Q.value = 1;

          // é…ç½®é«˜é€šæ»¤æ³¢å™¨ï¼ˆå»é™¤ä½é¢‘å™ªéŸ³ï¼‰
          highpassFilter.type = "highpass";
          highpassFilter.frequency.value = 80;
          highpassFilter.Q.value = 1;

          // é…ç½®å¤±çœŸï¼ˆæ¨¡æ‹Ÿç£å¸¦é¥±å’Œï¼‰
          distortionNode.curve = makeDistortionCurve(20);
          distortionNode.oversample = "4x";

          // é…ç½®å‹ç¼©å™¨ï¼ˆæ¨¡æ‹Ÿç£å¸¦å‹ç¼©ï¼‰
          compressorNode.threshold.value = -24;
          compressorNode.knee.value = 30;
          compressorNode.ratio.value = 12;
          compressorNode.attack.value = 0.003;
          compressorNode.release.value = 0.25;

          // å™ªéŸ³å¢ç›Šï¼ˆåˆå§‹ä¸º0ï¼‰
          noiseGainNode.gain.value = 0;

          // è¿æ¥èŠ‚ç‚¹é“¾ï¼šsource -> highpass -> lowpass -> distortion -> compressor -> gain -> noise -> destination
          highpassFilter.connect(lowpassFilter);
          lowpassFilter.connect(distortionNode);
          distortionNode.connect(compressorNode);
          compressorNode.connect(gainNode);
          noiseGainNode.connect(gainNode);
          gainNode.connect(audioContext.destination);

          // åˆ›å»ºç™½å™ªéŸ³æº
          createNoiseSource();
        }
      }

      // åˆ›å»ºå¤±çœŸæ›²çº¿
      function makeDistortionCurve(amount) {
        const samples = 44100;
        const curve = new Float32Array(samples);
        const deg = Math.PI / 180;
        for (let i = 0; i < samples; i++) {
          const x = (i * 2) / samples - 1;
          curve[i] =
            ((3 + amount) * x * 20 * deg) / (Math.PI + amount * Math.abs(x));
        }
        return curve;
      }

      // åˆ›å»ºç™½å™ªéŸ³æº
      function createNoiseSource() {
        if (noiseSource) {
          noiseSource.stop();
        }
        const bufferSize = audioContext.sampleRate * 2;
        const buffer = audioContext.createBuffer(
          1,
          bufferSize,
          audioContext.sampleRate
        );
        const output = buffer.getChannelData(0);

        for (let i = 0; i < bufferSize; i++) {
          output[i] = Math.random() * 2 - 1;
        }

        noiseSource = audioContext.createBufferSource();
        noiseSource.buffer = buffer;
        noiseSource.loop = true;
        noiseSource.connect(noiseGainNode);
        noiseSource.start(0);
      }

      // è¿æ¥è§†é¢‘éŸ³é¢‘åˆ°éŸ³é¢‘å¤„ç†é“¾
      function connectVideoAudio() {
        if (!audioContext || !video.src) return;

        try {
          // åˆ›å»ºåª’ä½“æºï¼ˆå¦‚æœè§†é¢‘æ²¡æœ‰éŸ³é¢‘è½¨é“ä¼šæŠ›å‡ºé”™è¯¯ï¼‰
          if (sourceNode) {
            sourceNode.disconnect();
            sourceNode = null;
          }

          sourceNode = audioContext.createMediaElementSource(video);
          sourceNode.connect(highpassFilter);
          hasAudio = true;

          // æ¢å¤éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆå¦‚æœè¢«æš‚åœï¼‰
          if (audioContext.state === "suspended") {
            audioContext.resume();
          }
        } catch (error) {
          // è§†é¢‘å¯èƒ½æ²¡æœ‰éŸ³é¢‘è½¨é“
          console.log("è§†é¢‘æ²¡æœ‰éŸ³é¢‘è½¨é“æˆ–éŸ³é¢‘ä¸Šä¸‹æ–‡åˆå§‹åŒ–å¤±è´¥:", error.message);
          hasAudio = false;
          sourceNode = null;
        }
      }

      // åº”ç”¨åŸºç¡€éŸ³é¢‘åšæ—§æ•ˆæœ
      function applyVintageAudio() {
        if (!audioContext || !hasAudio) return;

        // åŸºç¡€åšæ—§ï¼šè½»å¾®ä½é€šã€è½»å¾®å¤±çœŸã€è½»å¾®å‹ç¼©
        lowpassFilter.frequency.value = 5000;
        distortionNode.curve = makeDistortionCurve(15);
        gainNode.gain.value = 0.95; // ç¨å¾®é™ä½éŸ³é‡
        noiseGainNode.gain.value = 0.01; // è½»å¾®èƒŒæ™¯å™ªéŸ³
      }

      // åº”ç”¨éŸ³é¢‘æ•…éšœæ•ˆæœï¼ˆä¸è§†é¢‘æ•…éšœåŒæ­¥ï¼‰
      function applyAudioGlitch(type, duration, intensity = 1) {
        if (!audioContext || !hasAudio || !sourceNode) return;

        currentGlitchType = type;
        const now = audioContext.currentTime;
        const durationSec = duration / 1000;

        switch (type) {
          case "glitch-v-hold":
            // å‚ç›´æ»šåŠ¨æ•…éšœï¼šéŸ³è°ƒå¿«é€Ÿå˜åŒ– + å™ªéŸ³ + éŸ³é‡æ³¢åŠ¨
            // éŸ³é‡å¿«é€Ÿæ³¢åŠ¨ï¼ˆæ¨¡æ‹Ÿæ»šåŠ¨ï¼‰
            gainNode.gain.setValueAtTime(0.7, now);
            gainNode.gain.linearRampToValueAtTime(0.9, now + durationSec * 0.3);
            gainNode.gain.linearRampToValueAtTime(0.6, now + durationSec * 0.6);
            gainNode.gain.linearRampToValueAtTime(0.95, now + durationSec);

            // ä½é€šé¢‘ç‡å¿«é€Ÿå˜åŒ–ï¼ˆæ¨¡æ‹ŸéŸ³è°ƒæ³¢åŠ¨ï¼‰
            const baseFreq = 5000;
            lowpassFilter.frequency.setValueAtTime(
              baseFreq - 2000 * intensity,
              now
            );
            lowpassFilter.frequency.linearRampToValueAtTime(
              baseFreq + 1000 * intensity,
              now + durationSec * 0.25
            );
            lowpassFilter.frequency.linearRampToValueAtTime(
              baseFreq - 1500 * intensity,
              now + durationSec * 0.5
            );
            lowpassFilter.frequency.linearRampToValueAtTime(
              baseFreq,
              now + durationSec
            );

            // å¢åŠ å¤±çœŸ
            distortionNode.curve = makeDistortionCurve(25 + intensity * 15);
            setTimeout(() => {
              if (currentGlitchType !== "glitch-v-hold") return;
              distortionNode.curve = makeDistortionCurve(15);
            }, duration);

            // å¢åŠ å™ªéŸ³
            noiseGainNode.gain.setValueAtTime(0.15 * intensity, now);
            noiseGainNode.gain.exponentialRampToValueAtTime(
              0.01,
              now + durationSec
            );
            break;

          case "glitch-tear":
            // æ’•è£‚æ•…éšœï¼šçªç„¶é™éŸ³ + å¤±çœŸçˆ†å‘ + å™ªéŸ³
            // éŸ³é‡çªç„¶ä¸‹é™ç„¶åæ¢å¤
            gainNode.gain.setValueAtTime(0.2, now);
            gainNode.gain.exponentialRampToValueAtTime(0.95, now + durationSec);

            // å¤§å¹…å¢åŠ å¤±çœŸ
            distortionNode.curve = makeDistortionCurve(50 + intensity * 30);
            setTimeout(() => {
              if (currentGlitchType !== "glitch-tear") return;
              distortionNode.curve = makeDistortionCurve(15);
            }, duration);

            // ä½é€šé¢‘ç‡çªç„¶ä¸‹é™ï¼ˆæ¨¡æ‹Ÿä¿¡å·ä¸¢å¤±ï¼‰
            lowpassFilter.frequency.setValueAtTime(2000, now);
            lowpassFilter.frequency.exponentialRampToValueAtTime(
              5000,
              now + durationSec
            );

            // å™ªéŸ³çˆ†å‘
            noiseGainNode.gain.setValueAtTime(0.25 * intensity, now);
            noiseGainNode.gain.exponentialRampToValueAtTime(
              0.01,
              now + durationSec
            );
            break;

          case "glitch-chroma":
            // è‰²å½©ä¸¢å¤±æ•…éšœï¼šéŸ³è°ƒä¸‹é™ + ä½é€šå¢å¼º + è½»å¾®å¤±çœŸ
            // ä½é€šé¢‘ç‡ä¸‹é™ï¼ˆæ¨¡æ‹Ÿé«˜é¢‘ä¸¢å¤±ï¼‰
            lowpassFilter.frequency.setValueAtTime(2500, now);
            lowpassFilter.frequency.exponentialRampToValueAtTime(
              5000,
              now + durationSec
            );

            // è½»å¾®å¤±çœŸå¢åŠ 
            distortionNode.curve = makeDistortionCurve(20 + intensity * 10);
            setTimeout(() => {
              if (currentGlitchType !== "glitch-chroma") return;
              distortionNode.curve = makeDistortionCurve(15);
            }, duration);

            // éŸ³é‡è½»å¾®ä¸‹é™
            gainNode.gain.setValueAtTime(0.85, now);
            gainNode.gain.linearRampToValueAtTime(0.95, now + durationSec);

            // å¢åŠ å™ªéŸ³
            noiseGainNode.gain.setValueAtTime(0.12 * intensity, now);
            noiseGainNode.gain.exponentialRampToValueAtTime(
              0.01,
              now + durationSec
            );
            break;
        }
      }

      // æ ¹æ®trackingå€¼è°ƒæ•´éŸ³é¢‘å¹²æ‰°
      function applyTrackingAudioInterference(value) {
        if (!audioContext || !hasAudio) return;

        const intensity = value / 10;

        // å¢åŠ å™ªéŸ³
        noiseGainNode.gain.value = 0.01 + intensity * 0.1;

        // é™ä½ä½é€šé¢‘ç‡ï¼ˆæ¨¡æ‹Ÿä¿¡å·è¡°å‡ï¼‰
        lowpassFilter.frequency.value = 5000 - intensity * 2000;

        // å¢åŠ å¤±çœŸ
        distortionNode.curve = makeDistortionCurve(15 + intensity * 20);

        // è½»å¾®éŸ³è°ƒä¸ç¨³å®š
        if (intensity > 0.3) {
          const wobble = audioContext.createOscillator();
          const wobbleGain = audioContext.createGain();
          wobble.type = "sine";
          wobble.frequency.value = 1 + intensity * 2;
          wobbleGain.gain.value = intensity * 0.05;
          wobble.connect(wobbleGain);
          wobbleGain.connect(lowpassFilter.frequency);
          wobble.start();
          wobble.stop(audioContext.currentTime + 0.1);
        }
      }

      // --- 1. æ—¥æœŸå’Œæ—¶é—´ ---
      function updateTime() {
        const now = new Date();
        document.getElementById("timestamp").innerText = now.toLocaleTimeString(
          "en-US",
          { hour12: false }
        );
      }
      setInterval(updateTime, 1000);
      updateTime();

      // --- 2. åŠ¨æ€ç™½å™ª (Canvas) ---
      const ctx = noiseCanvas.getContext("2d");
      const resizeCanvas = () => {
        noiseCanvas.width = screen.offsetWidth / 2; // é™ä½åˆ†è¾¨ç‡ä»¥æå‡æ€§èƒ½
        noiseCanvas.height = screen.offsetHeight / 2;
      };
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();

      function drawNoise() {
        if (!isPoweredOn && !staticNoise.style.display === "none") return; // çœç”µ

        const w = noiseCanvas.width;
        const h = noiseCanvas.height;
        const idata = ctx.createImageData(w, h);
        const buffer32 = new Uint32Array(idata.data.buffer);
        const len = buffer32.length;

        for (let i = 0; i < len; i++) {
          if (Math.random() < 0.15) {
            // ç¨å¾®å¢åŠ å™ªç‚¹å¯†åº¦
            buffer32[i] = 0xffffffff;
          }
        }
        ctx.putImageData(idata, 0, 0);
        requestAnimationFrame(drawNoise);
      }
      drawNoise();

      // --- 3. éšæœºæ•…éšœç³»ç»Ÿ (Glitch System) ---
      function triggerRandomGlitch() {
        if (!isPoweredOn || video.paused) return;

        // 50% æ¦‚ç‡ä¸å‘ç”Ÿæ•…éšœï¼Œä¿æŒç”»é¢ç¨³å®š
        if (Math.random() > 0.4 && trackingControl.value == 0) return;

        const glitchTypes = ["glitch-v-hold", "glitch-tear", "glitch-chroma"];
        // å¦‚æœ tracking å€¼é«˜ï¼Œæ•…éšœæ¦‚ç‡å’Œä¸¥é‡ç¨‹åº¦å¢åŠ 
        const intensity = Math.max(1, parseInt(trackingControl.value)) / 10;

        // éšæœºé€‰æ‹©ä¸€ç§æ•…éšœ
        const type =
          glitchTypes[Math.floor(Math.random() * glitchTypes.length)];
        const duration = 100 + Math.random() * 400; // æŒç»­ 100-500ms

        // åº”ç”¨è§†é¢‘æ•…éšœ
        screen.classList.add(type);

        // åº”ç”¨éŸ³é¢‘æ•…éšœï¼ˆä¸è§†é¢‘åŒæ­¥ï¼‰
        applyAudioGlitch(type, duration, intensity);

        // ä¼´éšç™½å™ªçˆ†å‘
        const originalOpacity = noiseCanvas.style.opacity;
        noiseCanvas.style.opacity = 0.3 + Math.random() * 0.4;

        // æ¢å¤æ­£å¸¸
        setTimeout(() => {
          screen.classList.remove(type);
          currentGlitchType = null;
          // åªæœ‰å½“æ²¡æœ‰æ‰‹åŠ¨è°ƒèŠ‚ Tracking æ—¶æ‰æ¢å¤ä½å™ªç‚¹
          if (trackingControl.value == 0) {
            noiseCanvas.style.opacity = 0.08;
          } else {
            noiseCanvas.style.opacity = 0.08 + trackingControl.value / 15;
          }
        }, duration);
      }

      // å¯åŠ¨æ•…éšœå¾ªç¯
      function startGlitchLoop() {
        clearInterval(glitchInterval);
        // æ¯ 3-8 ç§’å°è¯•è§¦å‘ä¸€æ¬¡æ•…éšœ
        glitchInterval = setInterval(triggerRandomGlitch, 4000);
      }

      // --- 4. æ’­æ”¾æ§åˆ¶ ---
      fileInput.addEventListener("change", (e) => {
        if (e.target.files.length) handleFile(e.target.files[0]);
      });

      const zone = document.querySelector(".upload-zone");
      zone.addEventListener("dragover", (e) => {
        e.preventDefault();
        zone.style.borderColor = "#2dd760";
      });
      zone.addEventListener("dragleave", (e) => {
        e.preventDefault();
        zone.style.borderColor = "#555";
      });
      zone.addEventListener("drop", (e) => {
        e.preventDefault();
        zone.style.borderColor = "#555";
        if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
      });

      function handleFile(file) {
        const url = URL.createObjectURL(file);
        video.src = url;

        // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆåœ¨ç”¨æˆ·äº¤äº’åï¼‰
        initAudioContext();

        // ç§»åŠ¨è®¾å¤‡ï¼ˆiOS/Androidï¼‰éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾ï¼Œæ‰€ä»¥å»¶è¿Ÿåˆ°ç”¨æˆ·ç‚¹å‡»æ’­æ”¾æŒ‰é’®
        if (isMobileDevice()) {
          // æ ‡è®°æœ‰å¾…æ’­æ”¾çš„è§†é¢‘
          pendingVideoFile = true;

          // ç›‘å¬è§†é¢‘åŠ è½½å®Œæˆ
          video.addEventListener(
            "loadedmetadata",
            () => {
              connectVideoAudio();
              // åº”ç”¨åŸºç¡€åšæ—§æ•ˆæœ
              setTimeout(() => {
                applyVintageAudio();
              }, 100);

              // è§†é¢‘åŠ è½½å®Œæˆåï¼Œéšè—ä¸Šä¼  UIï¼Œæ˜¾ç¤ºè§†é¢‘å‡†å¤‡å°±ç»ªçŠ¶æ€
              uploadUI.style.display = "none";
              staticNoise.style.display = "none";
              screen.classList.add("crt-on");
              screen.classList.remove("crt-off");
              // æ˜¾ç¤ºæ’­æ”¾æç¤º
              osdPlay.style.display = "block";
              osdPlay.innerHTML =
                "READY â–¶ <br><span class='text-lg opacity-70'>â–¶</span>";
              // ç§»åŠ¨è®¾å¤‡ä¸Šä¸è®¾ç½®activeçŠ¶æ€ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»æ’­æ”¾
              // btnPlay.classList.add("active"); // ç§»é™¤è¿™è¡Œï¼Œé¿å…è¯¯å¯¼
              isPoweredOn = false; // æ ‡è®°ä¸ºæœªå¼€å¯ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»æ’­æ”¾
            },
            { once: true }
          );
        } else {
          // æ¡Œé¢è®¾å¤‡å¯ä»¥å°è¯•è‡ªåŠ¨æ’­æ”¾
          // ç›‘å¬è§†é¢‘åŠ è½½å®Œæˆï¼Œè¿æ¥éŸ³é¢‘
          video.addEventListener(
            "loadedmetadata",
            () => {
              connectVideoAudio();
              // åº”ç”¨åŸºç¡€åšæ—§æ•ˆæœ
              setTimeout(() => {
                applyVintageAudio();
              }, 100);
            },
            { once: true }
          );

          powerOn();
        }
      }

      function powerOn() {
        if (isPoweredOn && !pendingVideoFile) return;

        // å¦‚æœæ˜¯ iOS å¾…æ’­æ”¾çŠ¶æ€ï¼Œå…ˆæ¸…é™¤æ ‡è®°
        if (pendingVideoFile) {
          pendingVideoFile = false;
        } else {
          uploadUI.style.display = "none";
          staticNoise.style.display = "none";
          screen.classList.add("crt-on");
          screen.classList.remove("crt-off");
        }

        // ç¡®ä¿éŸ³é¢‘ä¸Šä¸‹æ–‡å·²æ¿€æ´»
        if (audioContext && audioContext.state === "suspended") {
          audioContext.resume();
        }

        // å°è¯•æ’­æ”¾ï¼Œå¤„ç†å¯èƒ½çš„é”™è¯¯
        const playPromise = video.play();
        if (playPromise !== undefined) {
          playPromise
            .then(() => {
              // æ’­æ”¾æˆåŠŸ
              isPoweredOn = true;
              osdPlay.style.display = "block";
              osdPlay.innerHTML =
                "â–¶ PLAY <br><span class='text-lg opacity-70'>SP</span>";
              btnPlay.classList.add("active");
              btnPause.classList.remove("active");
              startGlitchLoop();
            })
            .catch((error) => {
              // æ’­æ”¾è¢«é˜»æ­¢ï¼ˆé€šå¸¸æ˜¯ç§»åŠ¨è®¾å¤‡æˆ–æµè§ˆå™¨ç­–ç•¥ï¼‰
              console.log("è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢ï¼Œç­‰å¾…ç”¨æˆ·äº¤äº’:", error);
              // ä¿æŒå½“å‰çŠ¶æ€ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»æ’­æ”¾æŒ‰é’®
              if (!isMobileDevice()) {
                // æ¡Œé¢è®¾å¤‡å¦‚æœæ’­æ”¾å¤±è´¥ï¼Œæ˜¾ç¤ºæç¤º
                osdPlay.innerHTML =
                  "READY â–¶ <br><span class='text-lg opacity-70'>â–¶</span>";
              }
            });
        } else {
          // æ—§æµè§ˆå™¨å…¼å®¹
          isPoweredOn = true;
          osdPlay.style.display = "block";
          btnPlay.classList.add("active");
          startGlitchLoop();
        }
      }

      function eject() {
        screen.classList.remove("crt-on");
        screen.classList.add("crt-off");
        video.pause();
        clearInterval(glitchInterval); // åœæ­¢æ•…éšœ

        // æ¸…ç†éŸ³é¢‘èµ„æº
        if (sourceNode) {
          sourceNode.disconnect();
          sourceNode = null;
        }
        if (noiseSource) {
          noiseSource.stop();
          noiseSource = null;
        }
        hasAudio = false;
        currentGlitchType = null;
        pendingVideoFile = false; // æ¸…é™¤å¾…æ’­æ”¾æ ‡è®°

        osdPlay.style.display = "none";
        btnPlay.classList.remove("active");
        btnPause.classList.remove("active");

        setTimeout(() => {
          video.src = "";
          isPoweredOn = false;
          uploadUI.style.display = "block";
          staticNoise.style.display = "flex";
          screen.classList.remove("crt-off");
          fileInput.value = "";
        }, 600);
      }

      // æŒ‰é’®äº‹ä»¶
      btnPlay.addEventListener("click", () => {
        if (video.src) {
          // ç¡®ä¿éŸ³é¢‘ä¸Šä¸‹æ–‡å·²åˆå§‹åŒ–ï¼ˆç”¨æˆ·äº¤äº’æ—¶ï¼‰
          if (!audioContext) {
            initAudioContext();
          }
          if (audioContext && audioContext.state === "suspended") {
            audioContext.resume();
          }

          // å¦‚æœæ˜¯ iOS å¾…æ’­æ”¾çŠ¶æ€ï¼Œå…ˆå®Œæˆ powerOn æµç¨‹
          if (pendingVideoFile) {
            powerOn();
            return;
          }

          // å°è¯•æ’­æ”¾
          const playPromise = video.play();
          if (playPromise !== undefined) {
            playPromise
              .then(() => {
                // æ’­æ”¾æˆåŠŸ
                if (!isPoweredOn) powerOn();
                btnPlay.classList.add("active");
                btnPause.classList.remove("active");
                osdPlay.innerHTML =
                  "â–¶ PLAY <br><span class='text-lg opacity-70'>SP</span>";
              })
              .catch((error) => {
                console.log("æ’­æ”¾å¤±è´¥:", error);
                // å¦‚æœæ’­æ”¾å¤±è´¥ï¼Œå°è¯•è°ƒç”¨ powerOn
                if (!isPoweredOn) powerOn();
              });
          } else {
            // æ—§æµè§ˆå™¨å…¼å®¹
            video.play();
            if (!isPoweredOn) powerOn();
            btnPlay.classList.add("active");
            btnPause.classList.remove("active");
            osdPlay.innerHTML =
              "â–¶ PLAY <br><span class='text-lg opacity-70'>SP</span>";
          }
        }
      });

      btnPause.addEventListener("click", () => {
        if (video.src) video.pause();
        btnPlay.classList.remove("active");
        btnPause.classList.add("active");
        osdPlay.innerHTML =
          "â¸ PAUSE <br><span class='text-lg opacity-70'>SP</span>";
      });

      document.getElementById("btn-stop").addEventListener("click", eject);

      // --- 5. æ»¤é•œä¸æ§åˆ¶ ---
      window.setFilter = (filterClass, btn) => {
        screen.classList.remove("filter-vhs", "filter-bw", "filter-cyber");
        screen.classList.add(filterClass);

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document
          .querySelectorAll(".mode-btn")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");

        // åˆ‡æ¢æ—¶åˆ¶é€ ä¸€ç‚¹æ•…éšœ
        triggerRandomGlitch();
      };

      // Tracking æ‰‹åŠ¨å¹²æ‰°
      trackingControl.addEventListener("input", (e) => {
        const val = parseInt(e.target.value);
        if (val > 0) {
          // æ‰‹åŠ¨å¢åŠ è§†é¢‘å¹²æ‰°
          noiseCanvas.style.opacity = 0.08 + val / 15;
          // ä¸¥é‡æ—¶ç›´æ¥åº”ç”¨ CSS å˜æ¢
          video.style.transform = `skewX(${val}deg)`;
          video.style.filter = `blur(${val * 0.3}px)`;

          // åº”ç”¨éŸ³é¢‘å¹²æ‰°ï¼ˆä¸è§†é¢‘åŒæ­¥ï¼‰
          applyTrackingAudioInterference(val);

          // è§¦å‘æ›´é¢‘ç¹çš„éšæœºæ•…éšœ
          if (Math.random() > 0.7) triggerRandomGlitch();
        } else {
          // æ¢å¤æ­£å¸¸
          video.style.transform = "none";
          video.style.filter = "none";
          noiseCanvas.style.opacity = 0.08;

          // æ¢å¤éŸ³é¢‘
          if (audioContext && hasAudio) {
            applyVintageAudio();
          }
        }
      });
    </script>
  </body>
</html>
